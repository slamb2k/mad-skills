trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Validate
    jobs:
      - job: Lint
        displayName: Lint
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
            displayName: 'Setup Node.js'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm run lint --if-present
            displayName: 'Run linter'

      - job: Format
        displayName: Format Check
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
            displayName: 'Setup Node.js'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm run format:check --if-present || npx prettier --check .
            displayName: 'Check formatting'

      - job: TypeCheck
        displayName: Type Check
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
            displayName: 'Setup Node.js'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm run typecheck --if-present || npm run type-check --if-present || npx tsc --noEmit
            displayName: 'Run type check'

  - stage: Build
    dependsOn: Validate
    jobs:
      - job: Build
        displayName: Build
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
            displayName: 'Setup Node.js'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm run build
            displayName: 'Build'

  - stage: Test
    dependsOn: Build
    jobs:
      - job: Test
        displayName: Test
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
            displayName: 'Setup Node.js'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm test --if-present
            displayName: 'Run tests'
