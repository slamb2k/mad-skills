name: Validate

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Validate Playtight skill structure
      run: |
        echo "Validating Playtight skill structure..."

        # Check required files exist
        required_files=(
          "playtight/SKILL.md"
          "playtight/scripts/package.json"
          "playtight/scripts/check-element.js"
          "playtight/scripts/get-text.js"
          "playtight/scripts/take-screenshot.js"
          "playtight/scripts/navigate-and-extract.js"
          "playtight/agents/browser-investigator-subagent.md"
          "playtight/references/patterns.md"
        )

        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "ERROR: Required file missing: $file"
            exit 1
          fi
          echo "✓ Found: $file"
        done

    - name: Validate Pixel Pusher skill structure
      run: |
        echo "Validating Pixel Pusher skill structure..."

        # Check required files exist
        required_files=(
          "pixel-pusher/SKILL.md"
          "pixel-pusher/assets/design-system-template.json"
          "pixel-pusher/references/accessibility-guidelines.md"
          "pixel-pusher/references/design-best-practices.md"
          "pixel-pusher/references/design-system-layers.md"
          "pixel-pusher/references/persona-template.md"
          "pixel-pusher/references/style-guide-template.md"
          "pixel-pusher/references/user-flow-template.md"
        )

        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "ERROR: Required file missing: $file"
            exit 1
          fi
          echo "✓ Found: $file"
        done

    - name: Validate JSON files
      run: |
        echo "Validating JSON files..."

        # Validate marketplace.json
        if ! jq empty .claude-plugin/marketplace.json 2>/dev/null; then
          echo "ERROR: .claude-plugin/marketplace.json is not valid JSON"
          exit 1
        fi
        echo "✓ .claude-plugin/marketplace.json is valid JSON"

        # Validate Playtight scripts package.json
        if ! jq empty playtight/scripts/package.json 2>/dev/null; then
          echo "ERROR: playtight/scripts/package.json is not valid JSON"
          exit 1
        fi
        echo "✓ playtight/scripts/package.json is valid JSON"

        # Validate Pixel Pusher design system template
        if ! jq empty pixel-pusher/assets/design-system-template.json 2>/dev/null; then
          echo "ERROR: pixel-pusher/assets/design-system-template.json is not valid JSON"
          exit 1
        fi
        echo "✓ pixel-pusher/assets/design-system-template.json is valid JSON"

    - name: Install Playtight dependencies
      run: |
        cd playtight/scripts
        npm install

    - name: Validate scripts parse correctly
      run: |
        echo "Validating scripts can parse..."

        # Test that scripts at least parse correctly
        node -c playtight/scripts/check-element.js
        node -c playtight/scripts/get-text.js
        node -c playtight/scripts/take-screenshot.js
        node -c playtight/scripts/navigate-and-extract.js

        echo "✓ All scripts parse correctly"
