name: Validate

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Validate Play-Tight skill structure
      run: |
        echo "Validating Play-Tight skill structure..."

        # Check required files exist
        required_files=(
          "play-tight/SKILL.md"
          "play-tight/scripts/package.json"
          "play-tight/scripts/check-element.js"
          "play-tight/scripts/get-text.js"
          "play-tight/scripts/take-screenshot.js"
          "play-tight/scripts/navigate-and-extract.js"
          "play-tight/agents/browser-investigator-subagent.md"
          "play-tight/references/patterns.md"
        )

        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "ERROR: Required file missing: $file"
            exit 1
          fi
          echo "✓ Found: $file"
        done

    - name: Validate Pixel Pusher skill structure
      run: |
        echo "Validating Pixel Pusher skill structure..."

        # Check required files exist
        required_files=(
          "pixel-pusher/SKILL.md"
          "pixel-pusher/assets/design-system-template.json"
          "pixel-pusher/references/accessibility-guidelines.md"
          "pixel-pusher/references/design-best-practices.md"
          "pixel-pusher/references/design-system-layers.md"
          "pixel-pusher/references/persona-template.md"
          "pixel-pusher/references/style-guide-template.md"
          "pixel-pusher/references/user-flow-template.md"
        )

        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "ERROR: Required file missing: $file"
            exit 1
          fi
          echo "✓ Found: $file"
        done

    - name: Validate JSON files
      run: |
        echo "Validating JSON files..."

        # Validate marketplace.json
        if ! jq empty .claude-plugin/marketplace.json 2>/dev/null; then
          echo "ERROR: .claude-plugin/marketplace.json is not valid JSON"
          exit 1
        fi
        echo "✓ .claude-plugin/marketplace.json is valid JSON"

        # Validate Play-Tight scripts package.json
        if ! jq empty play-tight/scripts/package.json 2>/dev/null; then
          echo "ERROR: play-tight/scripts/package.json is not valid JSON"
          exit 1
        fi
        echo "✓ play-tight/scripts/package.json is valid JSON"

        # Validate Pixel Pusher design system template
        if ! jq empty pixel-pusher/assets/design-system-template.json 2>/dev/null; then
          echo "ERROR: pixel-pusher/assets/design-system-template.json is not valid JSON"
          exit 1
        fi
        echo "✓ pixel-pusher/assets/design-system-template.json is valid JSON"

    - name: Validate Cyberarian skill structure
      run: |
        echo "Validating Cyberarian skill structure..."

        # Check required files exist
        required_files=(
          "cyberarian/SKILL.md"
          "cyberarian/scripts/init_docs_structure.py"
          "cyberarian/scripts/index_docs.py"
          "cyberarian/scripts/archive_docs.py"
          "cyberarian/scripts/validate_doc_metadata.py"
          "cyberarian/assets/doc_template.md"
          "cyberarian/references/metadata-schema.md"
          "cyberarian/references/archiving-criteria.md"
          "cyberarian/agents/doc-librarian-subagent.md"
        )

        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "ERROR: Required file missing: $file"
            exit 1
          fi
          echo "✓ Found: $file"
        done

        # Validate Python scripts can at least be parsed
        echo "Validating Python scripts..."
        python3 -m py_compile cyberarian/scripts/init_docs_structure.py
        python3 -m py_compile cyberarian/scripts/index_docs.py
        python3 -m py_compile cyberarian/scripts/archive_docs.py
        python3 -m py_compile cyberarian/scripts/validate_doc_metadata.py
        echo "✓ All Python scripts parse correctly"

    - name: Validate Start Right skill structure
      run: |
        echo "Validating Start Right skill structure..."

        # Check required files exist
        required_files=(
          "start-right/SKILL.md"
          "start-right/scripts/init_git_repo.py"
          "start-right/scripts/setup_tooling.py"
          "start-right/scripts/setup_git_hooks.py"
          "start-right/scripts/generate_workflows.py"
          "start-right/scripts/setup_branch_protection.py"
          "start-right/references/project-types.md"
          "start-right/references/release-strategies.md"
        )

        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "ERROR: Required file missing: $file"
            exit 1
          fi
          echo "✓ Found: $file"
        done

        # Validate Python scripts can at least be parsed
        echo "Validating Python scripts..."
        python3 -m py_compile start-right/scripts/init_git_repo.py
        python3 -m py_compile start-right/scripts/setup_tooling.py
        python3 -m py_compile start-right/scripts/setup_git_hooks.py
        python3 -m py_compile start-right/scripts/generate_workflows.py
        python3 -m py_compile start-right/scripts/setup_branch_protection.py
        echo "✓ All Python scripts parse correctly"

    - name: Validate Graphite Skill structure
      run: |
        echo "Validating Graphite Skill structure..."

        # Check required files exist
        required_files=(
          "graphite-skill/SKILL.md"
          "graphite-skill/install.sh"
          "graphite-skill/settings.json"
          "graphite-skill/hooks/session-start.sh"
          "graphite-skill/agents/graphite-ops-template.md"
          "graphite-skill/references/quickstart.md"
          "graphite-skill/references/readme.md"
          "graphite-skill/references/team-configuration.md"
          "graphite-skill/test/verify-installation.sh"
        )

        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "ERROR: Required file missing: $file"
            exit 1
          fi
          echo "✓ Found: $file"
        done

        # Validate hook is executable
        if [ ! -x "graphite-skill/hooks/session-start.sh" ]; then
          echo "ERROR: Hook is not executable: graphite-skill/hooks/session-start.sh"
          exit 1
        fi
        echo "✓ Hook is executable"

        # Validate install script is executable
        if [ ! -x "graphite-skill/install.sh" ]; then
          echo "ERROR: Install script is not executable: graphite-skill/install.sh"
          exit 1
        fi
        echo "✓ Install script is executable"

    - name: Install Play-Tight dependencies
      run: |
        cd play-tight/scripts
        npm install

    - name: Validate scripts parse correctly
      run: |
        echo "Validating scripts can parse..."

        # Test that scripts at least parse correctly
        node -c play-tight/scripts/check-element.js
        node -c play-tight/scripts/get-text.js
        node -c play-tight/scripts/take-screenshot.js
        node -c play-tight/scripts/navigate-and-extract.js

        echo "✓ All scripts parse correctly"
